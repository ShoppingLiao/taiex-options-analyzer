# 資料來源改進：整合台灣證券交易所官方 API

**更新日期**: 2026年1月13日  
**版本**: v1.1.0  
**影響範圍**: 加權指數 OHLC 資料獲取方式

---

## 📊 更新內容

### 舊方式（已移除）
- **資料來源**: 手動從 PDF 提取或硬編碼
- **問題**:
  - PDF 格式變更時無法提取
  - 需要手動維護資料對照表
  - 準確性依賴人工輸入
  - 無法自動處理新日期

### 新方式（v1.1.0）
- **資料來源**: 台灣證券交易所官方 API
- **API 端點**: `https://www.twse.com.tw/rwd/zh/TAIEX/MI_5MINS_INDEX`
- **優點**:
  - ✅ 官方數據，準確可靠
  - ✅ 自動獲取任意日期
  - ✅ 不受 PDF 格式影響
  - ✅ 即時更新，無需維護

---

## 🔧 技術實作

### 1. 新增模組: `src/twse_fetcher.py`

```python
from src.twse_fetcher import TWSEDataFetcher

fetcher = TWSEDataFetcher()
ohlc = fetcher.fetch_ohlc("20260112")

# 返回結果
{
    'open': 30472.70,    # 開盤價
    'high': 30681.99,    # 最高價
    'low': 30472.70,     # 最低價
    'close': 30567.29    # 收盤價
}
```

**功能特點**:
- 自動從證交所 5 分鐘指數 API 獲取資料
- 智能處理 09:00:00 的前日收盤價（跳過不計）
- 計算當日真正的開高低收
- 完整的錯誤處理和友善提示
- 資料驗證（確保高≥開/收≥低）

### 2. 修改 `src/parser.py`

**新增方法**:
```python
def _fetch_twse_ohlc_data(self, trade_date: str) -> Optional[Dict]:
    """從台灣證交所 API 獲取加權指數 OHLC 資料"""
    fetcher = TWSEDataFetcher()
    ohlc = fetcher.fetch_ohlc(trade_date)
    return ohlc
```

**移除方法**:
```python
def _parse_tx_futures_data(self, pdf, trade_date: str):
    # 舊的硬編碼資料對照表，已移除
    tx_data_map = {
        '20260105': {...},
        '20260106': {...},
        ...
    }
```

---

## 📈 資料比對驗證

### 測試案例 1: 2026/01/12（週一）

**您提供的證交所數據**:
```
日期: 115/01/12
開盤: 30,472.70
最高: 30,681.99
最低: 30,472.70
收盤: 30,567.29
```

**新系統獲取結果**:
```
✅ 從證交所獲取 20260112 加權指數: 
   開 30472.70, 高 30681.99, 低 30472.70, 收 30567.29
```

**驗證**: ✅ 完全一致

### 測試案例 2: 2026/01/09（週五）

**證交所數據**:
```
日期: 115/01/09
開盤: 30,370.45
最高: 30,500.42
最低: 29,925.49
收盤: 30,288.96
```

**新系統獲取結果**:
```
✅ 從證交所獲取 20260109 加權指數: 
   開 30370.45, 高 30500.42, 低 29925.49, 收 30288.96
```

**驗證**: ✅ 完全一致

---

## 🎯 使用方式

### 對用戶透明
系統會自動從證交所獲取資料，無需任何額外操作：

```bash
# 生成單日報告
python3 main.py --date 20260112

# 系統自動執行：
# 1. 下載 PDF（選擇權數據）
# 2. 從證交所 API 獲取加權指數 OHLC
# 3. 合併資料生成完整報告
```

### 執行訊息
```
正在解析 PDF...
✅ 從證交所獲取 20260112 加權指數: 開 30472.70, 高 30681.99, 低 30472.70, 收 30567.29
找到 1 組資料

正在分析資料...
報告已產生: reports/report_20260112_202601.html
```

---

## ⚡ 性能與可靠性

### API 回應時間
- 平均: ~1-2 秒
- 超時設定: 10 秒
- 失敗重試: 使用 requests Session 複用連接

### 錯誤處理
```python
# 情境 1: 假日無交易
⚠️  20260111 無交易資料（可能是假日或尚未交易）

# 情境 2: 網路錯誤
❌ 網路請求失敗: Connection timeout

# 情境 3: API 異常
⚠️  證交所 API 回應異常: FAILED
```

### 資料驗證
自動檢查資料合理性：
- ✅ 最低價 ≤ 開盤價 ≤ 最高價
- ✅ 最低價 ≤ 收盤價 ≤ 最高價
- ✅ 最高價 ≥ 最低價

---

## 🔍 技術細節

### 5 分鐘指數資料處理

**原始資料結構**:
```json
{
    "stat": "OK",
    "date": "20260112",
    "data": [
        ["09:00:00", "30,288.96", ...],  ← 前日收盤價
        ["09:00:05", "30,472.70", ...],  ← 真正開盤價
        ["09:00:10", "30,540.32", ...],
        ...
        ["13:30:00", "30,567.29", ...]   ← 收盤價
    ]
}
```

**處理邏輯**:
1. 跳過第一筆（09:00:00 = 前日收盤）
2. 開盤 = 第二筆（09:00:05）
3. 最高 = max(所有交易時段)
4. 最低 = min(所有交易時段)
5. 收盤 = 最後一筆（13:30:00）

**資料筆數**: 每日約 3,241 筆（每 5 秒一筆）

---

## 📝 升級影響

### 正面影響
- ✅ 解決 PDF 無法解析時的問題
- ✅ 提高資料準確性和可靠性
- ✅ 支援任意歷史日期（證交所有資料的日期）
- ✅ 無需維護硬編碼資料表

### 注意事項
- ⚠️ 需要網路連線
- ⚠️ 假日或非交易日會返回無資料
- ⚠️ 依賴證交所 API 穩定性

### 向後相容
- ✅ 報告格式不變
- ✅ 使用方式不變
- ✅ 僅改變資料來源

---

## 🚀 未來改進

### 短期
- [ ] 添加快取機制（避免重複請求同一日期）
- [ ] 支援批量獲取多日資料
- [ ] 更詳細的 API 錯誤分類

### 中期
- [ ] 提供離線模式（使用快取資料）
- [ ] 支援其他指數（台灣 50、電子、金融等）
- [ ] 資料品質監控和警示

### 長期
- [ ] 整合更多證交所 API
- [ ] 提供歷史資料回測功能
- [ ] 建立本地資料庫減少 API 依賴

---

## 📚 相關文件

- **API 文檔**: https://www.twse.com.tw/zh/page/trading/index/MI_5MINS_INDEX.html
- **程式碼**: `src/twse_fetcher.py`, `src/parser.py`
- **測試**: `python3 src/twse_fetcher.py`

---

## ✅ 測試檢查清單

- [x] 單日報告生成正常
- [x] OHLC 數據與證交所一致
- [x] 報告中正確顯示開高低收
- [x] 假日處理正常
- [x] 錯誤訊息友善
- [x] 網路異常處理
- [x] 資料驗證通過
- [x] 向後相容性確認

---

**變更者**: Shopping Liao  
**完成時間**: 2026年1月13日  
**版本標籤**: v1.1.0 - TWSE API Integration

🎉 **從此以後，所有報告的加權指數資料都來自官方來源！**
