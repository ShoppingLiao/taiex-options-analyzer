name: Daily Options Report

on:
  # æ¯å€‹äº¤æ˜“æ—¥å°ç£æ™‚é–“ 16:00 åŸ·è¡Œ (UTC 08:00)
  schedule:
    - cron: '0 8 * * 1-5'  # é€±ä¸€åˆ°é€±äº” UTC 08:00

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYYMMDD)ï¼Œç•™ç©ºå‰‡ä½¿ç”¨ä»Šå¤©'
        required: false
        default: ''
      task:
        description: 'åŸ·è¡Œä»»å‹™'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto        # è‡ªå‹•åˆ¤æ–·ï¼ˆæ ¹æ“šæ˜ŸæœŸå¹¾ï¼‰
          - daily       # åªåŸ·è¡Œæ¯æ—¥å ±å‘Š
          - settlement  # åªåŸ·è¡Œçµç®—é å ±
          - review      # åªåŸ·è¡Œçµç®—æª¢è¨Ž

env:
  TZ: Asia/Taipei

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_changes: ${{ steps.commit.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Determine date and task
        id: config
        run: |
          # æ±ºå®šæ—¥æœŸ
          if [ -n "${{ github.event.inputs.date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date }}"
          else
            TARGET_DATE=$(date +%Y%m%d)
          fi
          echo "date=$TARGET_DATE" >> $GITHUB_OUTPUT

          # æ±ºå®šä»»å‹™
          TASK="${{ github.event.inputs.task }}"
          if [ "$TASK" = "auto" ] || [ -z "$TASK" ]; then
            # è‡ªå‹•åˆ¤æ–·ï¼šæ ¹æ“šæ˜ŸæœŸå¹¾
            WEEKDAY=$(date +%u)  # 1=é€±ä¸€, 5=é€±äº”
            echo "weekday=$WEEKDAY" >> $GITHUB_OUTPUT

            # é€±äºŒ(2)æˆ–é€±å››(4)ï¼šç”¢ç”Ÿçµç®—é å ±
            # é€±ä¸‰(3)æˆ–é€±äº”(5)ï¼šåŸ·è¡Œçµç®—æª¢è¨Ž
            # å…¶ä»–ï¼šåªç”¢ç”Ÿæ—¥å ±
            if [ "$WEEKDAY" = "2" ] || [ "$WEEKDAY" = "4" ]; then
              echo "task=settlement" >> $GITHUB_OUTPUT
            elif [ "$WEEKDAY" = "3" ] || [ "$WEEKDAY" = "5" ]; then
              echo "task=review" >> $GITHUB_OUTPUT
            else
              echo "task=daily" >> $GITHUB_OUTPUT
            fi
          else
            echo "task=$TASK" >> $GITHUB_OUTPUT
          fi

          echo "Target date: $TARGET_DATE"
          echo "Task: $TASK"

      - name: Check if trading day
        id: trading
        run: |
          python3 -c "
          from daily_workflow import is_trading_day
          from datetime import datetime

          date_str = '${{ steps.config.outputs.date }}'
          date_obj = datetime.strptime(date_str, '%Y%m%d')
          is_trading, reason = is_trading_day(date_obj)

          print(f'Date: {date_str}')
          print(f'Is trading day: {is_trading}')
          print(f'Reason: {reason}')

          # è¼¸å‡ºçµæžœä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'is_trading={str(is_trading).lower()}\n')
              f.write(f'reason={reason}\n')
          "

      - name: Run daily workflow
        if: steps.trading.outputs.is_trading == 'true'
        run: |
          echo "=== åŸ·è¡Œæ¯æ—¥å·¥ä½œæµ ==="
          echo "æ—¥æœŸ: ${{ steps.config.outputs.date }}"
          echo "ä»»å‹™: ${{ steps.config.outputs.task }}"

          python3 daily_workflow.py --date ${{ steps.config.outputs.date }} --skip-git

      - name: Skip non-trading day
        if: steps.trading.outputs.is_trading != 'true'
        run: |
          echo "=== éžäº¤æ˜“æ—¥ï¼Œè·³éŽåŸ·è¡Œ ==="
          echo "æ—¥æœŸ: ${{ steps.config.outputs.date }}"
          echo "åŽŸå› : ${{ steps.trading.outputs.reason }}"

      - name: Commit and push changes
        id: commit
        if: steps.trading.outputs.is_trading == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ è®Šæ›´çš„æª”æ¡ˆ
          git add docs/ reports/ logs/ data/ai_learning/

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --staged --quiet; then
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            DATE="${{ steps.config.outputs.date }}"
            TASK="${{ steps.config.outputs.task }}"

            case $TASK in
              daily)
                MSG="auto: $DATE æ¯æ—¥å ±å‘Š"
                ;;
              settlement)
                MSG="auto: $DATE çµç®—é å ±"
                ;;
              review)
                MSG="auto: $DATE çµç®—æª¢è¨Ž"
                ;;
              *)
                MSG="auto: $DATE æ¯æ—¥æ›´æ–°"
                ;;
            esac

            git commit -m "$MSG"
            git push

            echo "=== å·²æŽ¨é€è®Šæ›´ ==="
            echo "æäº¤è¨Šæ¯: $MSG"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## åŸ·è¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¥æœŸ**: ${{ steps.config.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»»å‹™**: ${{ steps.config.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **äº¤æ˜“æ—¥**: ${{ steps.trading.outputs.is_trading }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‹€æ…‹**: ${{ steps.trading.outputs.reason }}" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½² GitHub Pages
  deploy:
    needs: generate-report
    if: needs.generate-report.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # ç¢ºä¿å–å¾—æœ€æ–°çš„ main åˆ†æ”¯

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./docs"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deploy Summary
        run: |
          echo "## GitHub Pages éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ ç¶²ç«™å·²æ›´æ–°: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
