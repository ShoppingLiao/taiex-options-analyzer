name: Daily Options Report

on:
  # 每個交易日台灣時間 16:00 執行 (UTC 08:00)
  schedule:
    - cron: '0 8 * * 1-5'  # 週一到週五 UTC 08:00

  # 手動觸發
  workflow_dispatch:
    inputs:
      date:
        description: '指定日期 (YYYYMMDD)，留空則使用今天'
        required: false
        default: ''
      task:
        description: '執行任務'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto        # 自動判斷（根據星期幾）
          - daily       # 只執行每日報告
          - settlement  # 只執行結算預報
          - review      # 只執行結算檢討

env:
  TZ: Asia/Taipei

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Determine date and task
        id: config
        run: |
          # 決定日期
          if [ -n "${{ github.event.inputs.date }}" ]; then
            TARGET_DATE="${{ github.event.inputs.date }}"
          else
            TARGET_DATE=$(date +%Y%m%d)
          fi
          echo "date=$TARGET_DATE" >> $GITHUB_OUTPUT

          # 決定任務
          TASK="${{ github.event.inputs.task }}"
          if [ "$TASK" = "auto" ] || [ -z "$TASK" ]; then
            # 自動判斷：根據星期幾
            WEEKDAY=$(date +%u)  # 1=週一, 5=週五
            echo "weekday=$WEEKDAY" >> $GITHUB_OUTPUT

            # 週二(2)或週四(4)：產生結算預報
            # 週三(3)或週五(5)：執行結算檢討
            # 其他：只產生日報
            if [ "$WEEKDAY" = "2" ] || [ "$WEEKDAY" = "4" ]; then
              echo "task=settlement" >> $GITHUB_OUTPUT
            elif [ "$WEEKDAY" = "3" ] || [ "$WEEKDAY" = "5" ]; then
              echo "task=review" >> $GITHUB_OUTPUT
            else
              echo "task=daily" >> $GITHUB_OUTPUT
            fi
          else
            echo "task=$TASK" >> $GITHUB_OUTPUT
          fi

          echo "Target date: $TARGET_DATE"
          echo "Task: $TASK"

      - name: Check if trading day
        id: trading
        run: |
          python3 -c "
          from daily_workflow import is_trading_day
          from datetime import datetime

          date_str = '${{ steps.config.outputs.date }}'
          date_obj = datetime.strptime(date_str, '%Y%m%d')
          is_trading, reason = is_trading_day(date_obj)

          print(f'Date: {date_str}')
          print(f'Is trading day: {is_trading}')
          print(f'Reason: {reason}')

          # 輸出結果供後續步驟使用
          with open('$GITHUB_OUTPUT', 'a') as f:
              f.write(f'is_trading={str(is_trading).lower()}\n')
              f.write(f'reason={reason}\n')
          "

      - name: Run daily workflow
        if: steps.trading.outputs.is_trading == 'true'
        run: |
          echo "=== 執行每日工作流 ==="
          echo "日期: ${{ steps.config.outputs.date }}"
          echo "任務: ${{ steps.config.outputs.task }}"

          python3 daily_workflow.py --date ${{ steps.config.outputs.date }} --skip-git

      - name: Skip non-trading day
        if: steps.trading.outputs.is_trading != 'true'
        run: |
          echo "=== 非交易日，跳過執行 ==="
          echo "日期: ${{ steps.config.outputs.date }}"
          echo "原因: ${{ steps.trading.outputs.reason }}"

      - name: Commit and push changes
        if: steps.trading.outputs.is_trading == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 添加變更的檔案
          git add docs/ reports/ logs/ data/ai_learning/

          # 檢查是否有變更
          if git diff --staged --quiet; then
            echo "沒有變更需要提交"
          else
            DATE="${{ steps.config.outputs.date }}"
            TASK="${{ steps.config.outputs.task }}"

            case $TASK in
              daily)
                MSG="auto: $DATE 每日報告"
                ;;
              settlement)
                MSG="auto: $DATE 結算預報"
                ;;
              review)
                MSG="auto: $DATE 結算檢討"
                ;;
              *)
                MSG="auto: $DATE 每日更新"
                ;;
            esac

            git commit -m "$MSG"
            git push

            echo "=== 已推送變更 ==="
            echo "提交訊息: $MSG"
          fi

      - name: Summary
        run: |
          echo "## 執行結果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **日期**: ${{ steps.config.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **任務**: ${{ steps.config.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **交易日**: ${{ steps.trading.outputs.is_trading }}" >> $GITHUB_STEP_SUMMARY
          echo "- **狀態**: ${{ steps.trading.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
