<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æŒ‡é¸æ“‡æ¬Šåˆ†æå ±å‘Š - {{ date }}</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --call-color: #ef4444;
            --put-color: #22c55e;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            color: white;
            padding: 30px 20px;
            margin-bottom: 30px;
            border-radius: 12px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .positive {
            color: var(--put-color);
        }

        .negative {
            color: var(--call-color);
        }

        .neutral {
            color: var(--warning-color);
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .chart {
            width: 100%;
            height: 600px;
        }

        .chart-small {
            height: 400px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .key-levels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .level-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
        }

        .level-card.resistance {
            background-color: #fef2f2;
            border: 2px solid var(--call-color);
        }

        .level-card.support {
            background-color: #f0fdf4;
            border: 2px solid var(--put-color);
        }

        .level-card.max-pain {
            background-color: #fefce8;
            border: 2px solid var(--warning-color);
        }

        .level-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .level-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .level-detail {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* å¸‚å ´è§£è®€å€å¡Š */
        .analysis-section {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary-color);
        }

        .analysis-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        .analysis-list {
            list-style: none;
        }

        .analysis-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }

        .analysis-list li:last-child {
            border-bottom: none;
        }

        .analysis-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
        }

        .icon-bullish {
            background-color: #dcfce7;
            color: var(--put-color);
        }

        .icon-bearish {
            background-color: #fee2e2;
            color: var(--call-color);
        }

        .icon-neutral {
            background-color: #fef3c7;
            color: var(--warning-color);
        }

        /* åœ–ä¾‹ */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-call {
            background-color: var(--call-color);
        }

        .legend-put {
            background-color: var(--put-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--bg-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        td:first-child, th:first-child {
            text-align: left;
        }

        tr:hover {
            background-color: var(--bg-color);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .key-levels {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .card-value {
                font-size: 1.5rem;
            }

            .chart {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å°æŒ‡é¸æ“‡æ¬Šåˆ†æå ±å‘Š</h1>
            <div class="subtitle">
                äº¤æ˜“æ—¥æœŸ: {{ date }} | å¥‘ç´„æœˆä»½: {{ contract_month }} | çµç®—æ—¥: 2026/01/21
            </div>
        </header>

        <!-- é—œéµæŒ‡æ¨™å¡ç‰‡ -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Max Pain æœ€å¤§ç—›é»</div>
                <div class="card-value">{{ "{:,}".format(max_pain) }}</div>
                <div class="card-subtitle">é¸æ“‡æ¬Šçµç®—æ”¶æ–‚é»</div>
            </div>
            <div class="card">
                <div class="card-title">P/C Ratio (æœªå¹³å€‰)</div>
                <div class="card-value {{ 'negative' if pc_ratio_oi > 1.1 else ('positive' if pc_ratio_oi < 0.9 else 'neutral') }}">
                    {{ "%.4f"|format(pc_ratio_oi) }}
                </div>
                <div class="card-subtitle">{{ market_sentiment }}</div>
            </div>
            <div class="card">
                <div class="card-title">è²·æ¬Šç¸½æœªå¹³å€‰</div>
                <div class="card-value" style="color: var(--call-color);">{{ "{:,}".format(total_call_oi) }}</div>
                <div class="card-subtitle">
                    è®ŠåŒ–: <span class="{{ 'positive' if call_oi_change > 0 else 'negative' }}">{{ "{:+,}".format(call_oi_change) }}</span>
                </div>
            </div>
            <div class="card">
                <div class="card-title">è³£æ¬Šç¸½æœªå¹³å€‰</div>
                <div class="card-value" style="color: var(--put-color);">{{ "{:,}".format(total_put_oi) }}</div>
                <div class="card-subtitle">
                    è®ŠåŒ–: <span class="{{ 'positive' if put_oi_change > 0 else 'negative' }}">{{ "{:+,}".format(put_oi_change) }}</span>
                </div>
            </div>
        </div>

        <!-- é—œéµåƒ¹ä½ -->
        <div class="key-levels">
            <div class="level-card resistance">
                <div class="level-label">å£“åŠ›å€ (è²·æ¬Š OI æœ€å¤§)</div>
                <div class="level-value negative">{{ "{:,}".format(max_call_oi_strike) }}</div>
                <div class="level-detail">{{ "{:,}".format(max_call_oi) }} å£</div>
            </div>
            <div class="level-card max-pain">
                <div class="level-label">Max Pain</div>
                <div class="level-value">{{ "{:,}".format(max_pain) }}</div>
                <div class="level-detail">çµç®—æ”¶æ–‚é»</div>
            </div>
            <div class="level-card support">
                <div class="level-label">æ”¯æ’å€ (è³£æ¬Š OI æœ€å¤§)</div>
                <div class="level-value positive">{{ "{:,}".format(max_put_oi_strike) }}</div>
                <div class="level-detail">{{ "{:,}".format(max_put_oi) }} å£</div>
            </div>
        </div>

        <!-- å¸‚å ´è§£è®€ -->
        <div class="analysis-section">
            <h3 class="analysis-title">ğŸ“Š å¸‚å ´è§£è®€</h3>
            <ul class="analysis-list">
                {% for item in analysis_items %}
                <li>
                    <span class="analysis-icon {{ item.icon_class }}">{{ item.icon }}</span>
                    {{ item.text }}
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- OI åˆ†å¸ƒåœ– (æ°´å¹³å°ç¨±å¼) -->
        <div class="chart-container">
            <h3 class="chart-title">æœªå¹³å€‰é‡ (OI) åˆ†å¸ƒ</h3>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color legend-call"></div>
                    <span>è²·æ¬Š Call (å£“åŠ›)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-put"></div>
                    <span>è³£æ¬Š Put (æ”¯æ’)</span>
                </div>
            </div>
            <div id="oi-chart" class="chart"></div>
        </div>

        <!-- OI è®ŠåŒ–åœ– -->
        <div class="chart-container">
            <h3 class="chart-title">æœªå¹³å€‰é‡è®ŠåŒ– (OI Change)</h3>
            <div id="oi-change-chart" class="chart chart-small"></div>
        </div>

        <!-- è©³ç´°è³‡æ–™è¡¨ -->
        <h2 class="section-title">è©³ç´°è³‡æ–™</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>å±¥ç´„åƒ¹</th>
                        <th style="color: var(--call-color);">è²·æ¬Šæœªå¹³å€‰</th>
                        <th style="color: var(--call-color);">è²·æ¬ŠOIè®ŠåŒ–</th>
                        <th style="color: var(--put-color);">è³£æ¬Šæœªå¹³å€‰</th>
                        <th style="color: var(--put-color);">è³£æ¬ŠOIè®ŠåŒ–</th>
                        <th>ç¸½OI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in data_rows %}
                    <tr>
                        <td><strong>{{ "{:,}".format(row.strike) }}</strong></td>
                        <td style="color: var(--call-color);">{{ "{:,}".format(row.call_oi) }}</td>
                        <td class="{{ 'positive' if row.call_oi_change > 0 else ('negative' if row.call_oi_change < 0 else '') }}">
                            {{ "{:+,}".format(row.call_oi_change) }}
                        </td>
                        <td style="color: var(--put-color);">{{ "{:,}".format(row.put_oi) }}</td>
                        <td class="{{ 'positive' if row.put_oi_change > 0 else ('negative' if row.put_oi_change < 0 else '') }}">
                            {{ "{:+,}".format(row.put_oi_change) }}
                        </td>
                        <td>{{ "{:,}".format(row.call_oi + row.put_oi) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <footer>
            <p>å ±å‘Šç”¢ç”Ÿæ™‚é–“: {{ generated_at }} | TAIEX Options Analyzer</p>
        </footer>
    </div>

    <script>
        // OI åˆ†å¸ƒåœ– - æ°´å¹³å°ç¨±å¼ (å±¥ç´„åƒ¹åœ¨ä¸­é–“)
        const oiData = {{ oi_chart_data | safe }};
        const maxPain = {{ max_pain }};

        // Call å‘å·¦å»¶ä¼¸ (è² å€¼)ï¼ŒPut å‘å³å»¶ä¼¸ (æ­£å€¼)
        const callTrace = {
            y: oiData.strikes,
            x: oiData.call_oi.map(v => -v),
            name: 'è²·æ¬Š Call',
            type: 'bar',
            orientation: 'h',
            marker: {
                color: '#ef4444',
                line: { color: '#dc2626', width: 1 }
            },
            hovertemplate: 'å±¥ç´„åƒ¹: %{y}<br>è²·æ¬Š OI: %{customdata:,}<extra></extra>',
            customdata: oiData.call_oi
        };

        const putTrace = {
            y: oiData.strikes,
            x: oiData.put_oi,
            name: 'è³£æ¬Š Put',
            type: 'bar',
            orientation: 'h',
            marker: {
                color: '#22c55e',
                line: { color: '#16a34a', width: 1 }
            },
            hovertemplate: 'å±¥ç´„åƒ¹: %{y}<br>è³£æ¬Š OI: %{x:,}<extra></extra>'
        };

        // æ‰¾å‡ºæœ€å¤§å€¼ä»¥è¨­å®š x è»¸ç¯„åœ
        const maxOI = Math.max(...oiData.call_oi, ...oiData.put_oi);
        const axisRange = maxOI * 1.1;

        const oiLayout = {
            barmode: 'relative',
            bargap: 0.1,
            xaxis: {
                title: 'æœªå¹³å€‰é‡ (å£)',
                range: [-axisRange, axisRange],
                tickformat: ',d',
                tickvals: [-axisRange, -axisRange/2, 0, axisRange/2, axisRange],
                ticktext: [Math.round(axisRange).toLocaleString(), Math.round(axisRange/2).toLocaleString(), '0', Math.round(axisRange/2).toLocaleString(), Math.round(axisRange).toLocaleString()]
            },
            yaxis: {
                title: 'å±¥ç´„åƒ¹',
                tickformat: ',d',
                dtick: 500
            },
            showlegend: false,
            margin: { t: 20, r: 50, b: 50, l: 80 },
            shapes: [{
                type: 'line',
                x0: -axisRange,
                x1: axisRange,
                y0: maxPain,
                y1: maxPain,
                line: { color: '#f59e0b', width: 3, dash: 'dash' }
            }],
            annotations: [{
                x: axisRange * 0.8,
                y: maxPain,
                text: 'Max Pain: ' + maxPain.toLocaleString(),
                showarrow: true,
                arrowhead: 2,
                ax: 0,
                ay: -30,
                font: { color: '#f59e0b', size: 12, weight: 'bold' }
            },
            {
                x: -axisRange * 0.5,
                y: oiData.strikes[oiData.strikes.length - 1] + 200,
                text: 'â† Call (å£“åŠ›)',
                showarrow: false,
                font: { color: '#ef4444', size: 14, weight: 'bold' }
            },
            {
                x: axisRange * 0.5,
                y: oiData.strikes[oiData.strikes.length - 1] + 200,
                text: 'Put (æ”¯æ’) â†’',
                showarrow: false,
                font: { color: '#22c55e', size: 14, weight: 'bold' }
            }]
        };

        Plotly.newPlot('oi-chart', [callTrace, putTrace], oiLayout, {responsive: true});

        // OI è®ŠåŒ–åœ– - åŒæ¨£æ˜¯æ°´å¹³å°ç¨±å¼
        const callChangeTrace = {
            y: oiData.strikes,
            x: oiData.call_oi_change.map(v => -v),
            name: 'è²·æ¬Š OI è®ŠåŒ–',
            type: 'bar',
            orientation: 'h',
            marker: {
                color: oiData.call_oi_change.map(v => v >= 0 ? '#fca5a5' : '#ef4444')
            },
            hovertemplate: 'å±¥ç´„åƒ¹: %{y}<br>è²·æ¬Šè®ŠåŒ–: %{customdata:+,}<extra></extra>',
            customdata: oiData.call_oi_change
        };

        const putChangeTrace = {
            y: oiData.strikes,
            x: oiData.put_oi_change,
            name: 'è³£æ¬Š OI è®ŠåŒ–',
            type: 'bar',
            orientation: 'h',
            marker: {
                color: oiData.put_oi_change.map(v => v >= 0 ? '#86efac' : '#22c55e')
            },
            hovertemplate: 'å±¥ç´„åƒ¹: %{y}<br>è³£æ¬Šè®ŠåŒ–: %{x:+,}<extra></extra>'
        };

        const maxChange = Math.max(
            ...oiData.call_oi_change.map(Math.abs),
            ...oiData.put_oi_change.map(Math.abs)
        );
        const changeRange = maxChange * 1.2;

        const changeLayout = {
            barmode: 'relative',
            bargap: 0.1,
            xaxis: {
                title: 'OI è®ŠåŒ– (å£)',
                range: [-changeRange, changeRange],
                tickformat: '+,d'
            },
            yaxis: {
                title: 'å±¥ç´„åƒ¹',
                tickformat: ',d',
                dtick: 500
            },
            showlegend: false,
            margin: { t: 20, r: 50, b: 50, l: 80 },
            annotations: [{
                x: -changeRange * 0.5,
                y: oiData.strikes[oiData.strikes.length - 1] + 200,
                text: 'â† Call è®ŠåŒ–',
                showarrow: false,
                font: { color: '#ef4444', size: 12 }
            },
            {
                x: changeRange * 0.5,
                y: oiData.strikes[oiData.strikes.length - 1] + 200,
                text: 'Put è®ŠåŒ– â†’',
                showarrow: false,
                font: { color: '#22c55e', size: 12 }
            }]
        };

        Plotly.newPlot('oi-change-chart', [callChangeTrace, putChangeTrace], changeLayout, {responsive: true});
    </script>
</body>
</html>
